<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Filterklassen – Vergleich & Montagehilfe (Praxis)</title>
  <style>
    :root{
      --bg0:#070a12; --bg1:#0c1222; --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12); --line2:rgba(255,255,255,.18);
      --text:#eef2ff; --muted:#a9b3d6; --muted2:#8a95bb;
      --accent:#7aa2ff; --ok:#b7ffda; --warn:#ffd48a; --bad:#ff9aa6;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(183,255,218,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:22px; }
    header{ display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; margin-bottom:14px; }
    h1{ margin:0 0 6px; font-size:20px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; line-height:1.45; max-width:980px; }
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px; border:1px solid var(--line); border-radius:999px;
      background:rgba(255,255,255,.04); color:var(--muted); font-size:12px;
      backdrop-filter: blur(6px);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }
    .dot.ok{ background:var(--ok); }
    .dot.warn{ background:var(--warn); }

    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; }
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{ margin:0 0 10px; font-size:14px; }

    .section{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
      background: rgba(255,255,255,.035);
    }
    .section + .section{ margin-top:12px; }

    .sectionHead{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .step{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(122,162,255,.35);
      background: rgba(122,162,255,.10);
      color: var(--text);
      font-size: 12px;
      width: fit-content;
    }
    .step2{ border-color: rgba(183,255,218,.28); background: rgba(183,255,218,.07); }
    .step3{ border-color: rgba(255,212,138,.28); background: rgba(255,212,138,.07); }

    .sectionTitle{ font-weight:700; }
    .sectionDesc{ color:var(--muted); font-size:12px; line-height:1.35; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 680px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }

    select,input,button{
      width:100%; padding:11px 11px; border-radius:14px;
      border:1px solid var(--line2); background:rgba(10,15,36,.85);
      color:var(--text); outline:none;
    }
    input::placeholder{ color:rgba(169,179,214,.65); }
    select:focus,input:focus{ border-color: rgba(122,162,255,.55); box-shadow: 0 0 0 4px rgba(122,162,255,.12); }

    button{ cursor:pointer; }
    .btn{
      background:linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.10));
      border-color: rgba(122,162,255,.40);
    }
    .btn2{
      background:linear-gradient(180deg, rgba(183,255,218,.16), rgba(183,255,218,.08));
      border-color: rgba(183,255,218,.30);
    }
    .btnGhost{
      background:rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }
    .btn:hover, .btn2:hover, .btnGhost:hover{ filter:brightness(1.07); }

    .hint{
      font-size:12px; color:var(--muted); line-height:1.45;
      background:rgba(255,255,255,.03);
      border:1px dashed rgba(255,255,255,.14);
      border-radius:16px;
      padding:10px;
    }
    .mono{ font-family:var(--mono); }
    .mini{ font-size:11px; color:var(--muted2); margin-top:6px; line-height:1.35; }

    .resultGrid{ display:grid; grid-template-columns: 1fr; gap:10px; }

    .rCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.04);
    }
    .rTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      background:rgba(255,255,255,.03);
      white-space:nowrap; height: fit-content;
    }
    .bigMono{ font-family:var(--mono); font-size:16px; letter-spacing:.2px; }

    /* Ampel + Einsatzblock */
    .metaRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    .ampel{
      display:flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 12px; color: var(--muted); width: fit-content;
    }
    .lamp{ width:10px; height:10px; border-radius:50%; background:#666; }
    .lamp.g{ background: var(--ok); }
    .lamp.y{ background: var(--warn); }
    .lamp.r{ background: var(--bad); }

    .useBlock{
      margin-top:10px; padding:10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.025);
    }
    .useTitle{ font-size:12px; color:var(--muted2); margin:0 0 6px; }
    .useText{ font-size:13px; margin:0; color: var(--text); }
    .useHint{ font-size:12px; margin-top:8px; color: var(--muted); line-height:1.45; }

    /* Ampel-Legende */
    .legend{
      display:grid; grid-template-columns: 1fr; gap:8px;
      margin: 10px 0 0;
    }
    .legend .item{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px; border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.025);
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .legend .b{ font-weight:700; color:var(--text); }

    .footer{ margin-top:14px; font-size:12px; color:var(--muted); }
    .warnText{ color:var(--warn); }

    /* Print */
    @media print{
      body{ background:#fff !important; color:#111 !important; }
      header, #leftPanel, #actionRow, #exampleBlock, #mountBlock, #legendBlock { display:none !important; }
      .wrap{ max-width:none; padding:0; }
      .grid{ grid-template-columns: 1fr !important; }
      .card{ background:#fff !important; border:1px solid #ddd !important; box-shadow:none !important; }
      .rCard{ background:#fff !important; border:1px solid #ddd !important; }
      .hint{ background:#fafafa !important; border:1px dashed #bbb !important; color:#333 !important; }
      .badge, .ampel{ border:1px solid #ccc !important; color:#333 !important; background:#fafafa !important; }
      .useBlock{ border:1px solid #ddd !important; background:#fafafa !important; }
      .warnText, .footer{ color:#333 !important; }
      #printHeader{ display:block !important; }
    }
    #printHeader{
      display:none;
      margin: 0 0 10px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }
    #printHeader .t{ font-weight:700; font-size:14px; }
    #printHeader .s{ font-size:12px; color:var(--muted); margin-top:4px; }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Filterklassen – Vergleich & Montagehilfe (Praxis)</h1>
      <p class="sub">
        Links eingeben → rechts erhältst du Vergleichsklassen (Richtwert), Erklärung und zusätzlich eine
        <b>Montagehilfe für Taschenfilter</b> (Taschen müssen frei hängen/stehen, nicht umknicken).
      </p>
    </div>
    <div class="pillrow">
      <span class="pill"><span class="dot ok"></span>Monteur-tauglich</span>
      <span class="pill"><span class="dot ok"></span>läuft stabil auf GitHub Pages</span>
      <span class="pill"><span class="dot warn"></span>Vergleich = Richtwert</span>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <section class="card" id="leftPanel">
      <div class="section">
        <div class="sectionHead">
          <div>
            <div class="step"><b>Schritt 1</b> Eingabe</div>
            <div class="sectionTitle" style="margin-top:8px;">Norm und Filterklasse eingeben</div>
            <div class="sectionDesc">Schnell: <span class="mono">F7</span> oder <span class="mono">ePM1 60%</span> → Enter.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Norm / Standard</label>
            <select id="stdSelect">
              <option value="iso16890">ISO 16890 (ePM…)</option>
              <option value="en779">EN 779 (G/M/F – Bestandsanlagen)</option>
              <option value="en1822">EN 1822 (EPA / HEPA / ULPA)</option>
              <option value="merv">ASHRAE 52.2 (MERV)</option>
            </select>
          </div>
          <div>
            <label>Schnelleingabe (z. B. „F7“ oder „ePM1 60%“)</label>
            <input id="quickInput" placeholder='Beispiele: ePM1 60% | Coarse 70% | F7 | F5 | H13 | MERV 13' />
            <div class="mini">Enter → automatisch erkennen und anzeigen</div>
          </div>
        </div>

        <div class="row" id="isoBlock" style="margin-top:10px;">
          <div>
            <label>ISO 16890 Fraktion</label>
            <select id="isoFrac">
              <option value="ePM1">ePM1 (sehr fein)</option>
              <option value="ePM25">ePM2,5 (Feinstaub)</option>
              <option value="ePM10">ePM10 (Pollen/Staub)</option>
              <option value="Coarse">Coarse (Vorfilter – grob)</option>
            </select>
            <div class="mini"><b>Coarse</b> = Grobfilter für große Partikel (Vorfilter/Anlagenschutz).</div>
          </div>
          <div>
            <label>Abscheidegrad [%]</label>
            <input id="isoPct" type="number" min="0" max="100" value="60"/>
          </div>
        </div>

        <div class="row" id="en779Block" style="display:none; margin-top:10px;">
          <div>
            <label>EN 779 Klasse (Bestand)</label>
            <select id="en779Sel"></select>
          </div>
          <div>
            <label>Hinweis</label>
            <div class="hint"><b>Altbezeichnungen:</b> <span class="mono">F5 ≈ M5</span> und <span class="mono">F6 ≈ M6</span>.</div>
          </div>
        </div>

        <div class="row" id="en1822Block" style="display:none; margin-top:10px;">
          <div>
            <label>EN 1822 Klasse (EPA/HEPA/ULPA)</label>
            <select id="en1822Sel"></select>
          </div>
          <div>
            <label>Einfach erklärt</label>
            <div class="hint"><b>HEPA ist Endfilter</b> (eigene Norm). Das wird nicht „umgerechnet“, sondern als Endstufe eingeordnet.</div>
          </div>
        </div>

        <div class="row" id="mervBlock" style="display:none; margin-top:10px;">
          <div>
            <label>MERV</label>
            <select id="mervSel"></select>
          </div>
          <div>
            <label>Hinweis</label>
            <div class="hint">MERV ist US-System. Vergleich zu ISO/EN ist <b>nur Richtwert</b>.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;" id="actionRow">
          <button class="btn" id="applyBtn">Vergleich anzeigen</button>
          <button class="btnGhost" id="resetBtn">Zurücksetzen</button>
        </div>

        <div class="hint" style="margin-top:12px;">
          <b>Merksatz:</b> <span class="mono">ePM1 60%</span> bedeutet: ca. <b>60%</b> Abscheidung der <b>PM1-Partikel</b> im ISO-Test.
        </div>
      </div>

      <div class="section" id="exampleBlock">
        <div class="sectionHead">
          <div>
            <div class="step step2"><b>Schritt 2</b> Beispiele</div>
            <div class="sectionTitle" style="margin-top:8px;">Typische Filter-Kombinationen (Voreinstellungen)</div>
            <div class="sectionDesc">Hilft, wenn man schnell eine übliche Kette auswählen will (Vorfilter + Feinfilter, ggf. HEPA).</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Beispiel auswählen</label>
            <select id="presetSel"></select>
            <div class="mini" id="presetHint"></div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn2" id="presetApplyBtn">Beispiel übernehmen</button>
          </div>
        </div>
      </div>

      <div class="section" id="mountBlock">
        <div class="sectionHead">
          <div>
            <div class="step step3"><b>Schritt 3</b> Montagehilfe</div>
            <div class="sectionTitle" style="margin-top:8px;">Taschenfilter – Einbaulage / Taschenrichtung prüfen</div>
            <div class="sectionDesc">
              Problem: Bei falscher Lage <b>knicken Taschen um</b> / liegen auf / werden „zu“. Ziel: Taschen müssen <b>frei hängen/stehen</b>.
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Rahmenmaß (mm) – Breite</label>
            <input id="mW" type="number" min="50" step="1" placeholder="z. B. 592"/>
          </div>
          <div>
            <label>Rahmenmaß (mm) – Höhe</label>
            <input id="mH" type="number" min="50" step="1" placeholder="z. B. 592"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Einbaulage</label>
            <select id="mOrient">
              <option value="vertical">Vertikal (Filter steht)</option>
              <option value="horizontal">Horizontal (Filter liegt)</option>
            </select>
          </div>
          <div>
            <label>Taschen-Anforderung</label>
            <select id="mNeed">
              <option value="hang">Taschen sollen frei hängen (nicht aufliegen)</option>
              <option value="stand">Taschen sollen frei stehen (nicht umknicken)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn2" id="mCheckBtn">Einbaulage prüfen</button>
          <button class="btnGhost" id="mResetBtn">Felder leeren</button>
        </div>

        <div class="hint" id="mOut" style="margin-top:12px;">
          Trage Maße ein und prüfe. Hinweis: <b>Luftstrom-Pfeil</b> und <b>Aufdruck „TOP“</b> am Filter immer beachten.
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card" id="rightPanel">
      <div id="printHeader">
        <div class="t">Filterklassen – Ergebnis</div>
        <div class="s" id="printMeta"></div>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;">
        <h2 style="margin:0;">Vergleichsausgabe</h2>
        <button class="btnGhost" id="printBtn" style="width:auto; padding:9px 12px;">Drucken / PDF</button>
      </div>

      <div id="summary" class="hint" style="margin:10px 0;">
        Links eine Norm/Klasse eingeben.
      </div>

      <div class="section" id="legendBlock">
        <div class="sectionTitle">Ampel-Legende</div>
        <div class="legend">
          <div class="item"><span class="lamp g"></span><div><span class="b">Grün:</span> gute Vergleichsklasse (Richtwert). Hilft beim Einordnen.</div></div>
          <div class="item"><span class="lamp y"></span><div><span class="b">Gelb:</span> Vergleich nur grob (Richtwert). Für EU besser ISO 16890 nutzen.</div></div>
          <div class="item"><span class="lamp r"></span><div><span class="b">Rot:</span> nicht umrechnen (eigene Norm/Filtertyp) – z. B. HEPA (EN 1822).</div></div>
        </div>
      </div>

      <div class="resultGrid" id="results" style="margin-top:12px;"></div>

      <div class="footer">
        <div class="warnText">
          <b>Wichtig:</b> Für Auswahl/Bestellung zählt das <b>Datenblatt</b> (ePM-Werte, Druckverlust, Dichtheit) und das Anlagenkonzept.
        </div>
      </div>
    </section>
  </div>
</div>

<script>
/* ========= Daten ========= */

const EN779 = [
  { id:"G4", label:"G4", stage:"Vorfilter", notes:["Vorfilter/Anlagenschutz, Standzeit der Feinfilter erhöhen."]},
  { id:"M5", label:"M5 (ehem. F5)", alias:["F5","M5"], stage:"Mittelfilter", notes:["Mittelfilter / Schutzstufe vor Feinfiltern (Alt: F5)."]},
  { id:"M6", label:"M6 (ehem. F6)", alias:["F6","M6"], stage:"Mittelfilter", notes:["Bessere Vorstufe vor F7/F9 (Alt: F6)."]},
  { id:"F7", label:"F7", stage:"Feinfilter", notes:["Häufiger Zuluft-Feinfilter (Büro/Lehre je nach Konzept)."]},
  { id:"F8", label:"F8", stage:"Feinfilter (hoch)", notes:["Höhere Feinabscheidung (z. B. Stadtlage)."]},
  { id:"F9", label:"F9", stage:"Feinfilter (sehr hoch)", notes:["Sehr hohe Feinabscheidung, oft vor HEPA-Endfiltern."]},
];

const ISO_FRAC_DESC = {
  ePM1:  "PM1 (sehr feine Partikel)",
  ePM25: "PM2,5 (Feinstaub)",
  ePM10: "PM10 (Pollen/Staub)",
  Coarse:"Coarse = Grobfilter (>10 µm) – typischer Vorfilter/Anlagenschutz"
};

const EN779_TO_HINT = {
  G4: { iso:["ISO Coarse 60–80%"], merv:["MERV 6–8"] },
  M5: { iso:["ISO ePM10 50–70%"],  merv:["MERV 9–10"] },
  M6: { iso:["ISO ePM10 60–80%"],  merv:["MERV 10–12"] },
  F7: { iso:["ISO ePM1 55–65%"],   merv:["MERV 13"] },
  F8: { iso:["ISO ePM1 70–85%"],   merv:["MERV 14"] },
  F9: { iso:["ISO ePM1 80–90%"],   merv:["MERV 15"] },
};

function isoToEn779(frac, pct){
  pct = Number(pct);
  const hits = [];
  if(frac==="Coarse"){ hits.push("G4"); }
  if(frac==="ePM10"){
    if(pct>=50 && pct<=70) hits.push("M5");
    if(pct>=60) hits.push("M6");
    if(pct>=80) hits.push("F7");
  }
  if(frac==="ePM25"){
    if(pct<65 && pct>=35) hits.push("M6");
    if(pct>=65) hits.push("F7");
    if(pct>=75) hits.push("F8");
    if(pct>=85) hits.push("F9");
  }
  if(frac==="ePM1"){
    if(pct<40) hits.push("M6");
    if(pct>=40 && pct<=65) hits.push("F7");
    if(pct>=65 && pct<=90) hits.push("F8");
    if(pct>=80) hits.push("F9");
  }
  return [...new Set(hits)];
}

const MERV = [
  { id:"MERV 8",  iso:"ISO ePM10 ~50% / Coarse", use:"Vor-/Mittelfilter (Schutz)" },
  { id:"MERV 11", iso:"ISO ePM10 ~60–70%",      use:"bessere Vorstufe" },
  { id:"MERV 13", iso:"ISO ePM1 ~50–65%",       use:"Feinfilter (US-Bezug)" },
  { id:"MERV 14", iso:"ISO ePM1 ~70–85%",       use:"Feinfilter (hoch)" },
  { id:"MERV 15", iso:"ISO ePM1 ~80–90%",       use:"sehr hoch, oft vor Endstufen" },
  { id:"MERV 16", iso:"ISO ePM1 ~90–95%",       use:"sehr hoch (noch vor HEPA)" },
];

const EN1822 = [
  { id:"E10 (EPA)",  eff:"≥ 85% (MPPS)",       use:"EPA-Vorstufe vor HEPA" },
  { id:"E11 (EPA)",  eff:"≥ 95% (MPPS)",       use:"EPA-Vorstufe vor HEPA" },
  { id:"E12 (EPA)",  eff:"≥ 99,5% (MPPS)",     use:"EPA-Vorstufe (hoch)" },
  { id:"H13 (HEPA)", eff:"≥ 99,95% (MPPS)",    use:"HEPA-Endfilter (häufig)" },
  { id:"H14 (HEPA)", eff:"≥ 99,995% (MPPS)",   use:"HEPA-Endfilter (sehr hoch)" },
  { id:"U15 (ULPA)", eff:"≥ 99,9995% (MPPS)",  use:"ULPA (Reinraum/High-End)" },
  { id:"U16 (ULPA)", eff:"≥ 99,99995% (MPPS)", use:"ULPA (Reinraum/High-End)" },
  { id:"U17 (ULPA)", eff:"≥ 99,999995% (MPPS)",use:"ULPA (Reinraum/High-End)" },
];

const PRESETS = [
  {
    id:"office_std",
    name:"Büro/Lehre – Standard (Vorfilter + Feinfilter)",
    apply:{ std:"iso16890", iso:{ frac:"ePM1", pct:60 } },
    chain:[
      { stage:"Vorfilter", value:"ISO Coarse 60–70% (≈ G4)" },
      { stage:"Feinfilter", value:"ISO ePM1 55–65% (≈ F7)" }
    ],
    notes:["Standardlösung in vielen RLT-Anlagen (je nach Konzept)."]
  },
  {
    id:"office_city",
    name:"Büro – Stadtlage (bessere Feinabscheidung)",
    apply:{ std:"iso16890", iso:{ frac:"ePM1", pct:80 } },
    chain:[
      { stage:"Vorfilter", value:"ISO Coarse 70–80%" },
      { stage:"Feinfilter", value:"ISO ePM1 70–85% (≈ F8)" }
    ],
    notes:["Mehr Schutz, oft mehr Druckverlust → Auslegung beachten."]
  },
  {
    id:"lab_general",
    name:"Labor allgemein (ohne Reinraum) – höhere Feinfilterstufe",
    apply:{ std:"en779", en779:{ cls:"F9" } },
    chain:[
      { stage:"Vorfilter", value:"ISO Coarse 70–80%" },
      { stage:"Feinfilter", value:"ISO ePM1 80–90% (≈ F9)" }
    ],
    notes:["HEPA nur, wenn Prozess/Hygiene das fordert."]
  },
  {
    id:"hepa_end",
    name:"HEPA-Endfilter (H13) – typische Kette",
    apply:{ std:"en1822", en1822:{ id:"H13 (HEPA)" } },
    chain:[
      { stage:"Vorfilter", value:"ISO Coarse 70–80%" },
      { stage:"Feinfilter", value:"ISO ePM1 80–90% (≈ F9)" },
      { stage:"Endfilter", value:"H13 (HEPA) – EN 1822" }
    ],
    notes:["HEPA = Endfilter. Dichtheit/Einbau wichtig."]
  }
];

/* ========= UI ========= */
const $ = (id)=>document.getElementById(id);
function show(id, on){ $(id).style.display = on ? "" : "none"; }
function setSummary(html){ $("summary").innerHTML = html; }
function clearResults(){ $("results").innerHTML = ""; }

function setPrintMeta(text){
  const dt=new Date().toLocaleString("de-DE");
  $("printMeta").textContent = `${text} • erstellt: ${dt}`;
}

function ampelText(level){
  if(level==="green") return { lamp:"g", text:"Grün: gute Vergleichsklasse (Richtwert)" };
  if(level==="yellow") return { lamp:"y", text:"Gelb: Vergleich nur grob (Richtwert)" };
  return { lamp:"r", text:"Rot: nicht umrechnen (eigene Norm/Filtertyp)" };
}

function addCard({title,badge,main,ampelLevel,useTitle,useText,useHint,items}){
  const a = ampelText(ampelLevel||"yellow");
  const div=document.createElement("div");
  div.className="rCard";
  div.innerHTML=`
    <div class="rTop">
      <div>
        <div><b>${title}</b></div>
        <div class="bigMono">${main||""}</div>
        <div class="metaRow">
          <div class="ampel">
            <span class="lamp ${a.lamp}"></span>
            <span>${a.text}</span>
          </div>
        </div>
      </div>
      <div class="badge">${badge||""}</div>
    </div>

    <div class="useBlock">
      <div class="useTitle">${useTitle||"Wofür nutzt man das?"}</div>
      <p class="useText">${useText||"—"}</p>
      ${useHint ? `<div class="useHint">${useHint}</div>` : ``}
    </div>

    <div class="rBody">
      ${items && items.length ? `<ul>${items.map(x=>`<li>${x}</li>`).join("")}</ul>` : ""}
    </div>
  `;
  $("results").appendChild(div);
}

function normQ(s){ return (s||"").trim().replace(/\s+/g," ").toUpperCase(); }
function parseQuick(q){
  const s=normQ(q);

  let m=s.match(/(EPM1|EPM2,5|EPM25|EPM10|COARSE)\s*([0-9]{1,3})\s*%?/);
  if(m){
    let frac=m[1];
    if(frac==="EPM1") frac="ePM1";
    else if(frac==="EPM10") frac="ePM10";
    else if(frac==="EPM2,5"||frac==="EPM25") frac="ePM25";
    else frac="Coarse";
    const pct=Math.max(0,Math.min(100,Number(m[2])));
    return {std:"iso16890", iso:{frac,pct}};
  }

  m=s.match(/\b(G4|F5|F6|F7|F8|F9|M5|M6)\b/);
  if(m){
    let cls=m[1];
    if(cls==="F5") cls="M5";
    if(cls==="F6") cls="M6";
    return {std:"en779", en779:{cls}};
  }

  m=s.match(/\b(E10|E11|E12|H13|H14|U15|U16|U17)\b/);
  if(m){
    const code=m[1];
    const id = EN1822.find(x=>x.id.startsWith(code))?.id || (code+" (EN 1822)");
    return {std:"en1822", en1822:{id}};
  }

  m=s.match(/\bMERV\s*([0-9]{1,2})\b/);
  if(m) return {std:"merv", merv:{id:`MERV ${Number(m[1])}`}};

  return null;
}

function renderChain(p){
  addCard({
    title:"Ausgewähltes Beispiel (Filterkombination)",
    badge:"Praxis-Beispiel",
    main:"",
    ampelLevel:"green",
    useTitle:"Wofür ist das gedacht?",
    useText:"Als typische Kombination in der Anlage (Vorfilter + Feinfilter, ggf. HEPA-Endfilter).",
    useHint:"Hilft beim schnellen Einordnen. Für Bestellung gilt: Datenblatt + Konzept.",
    items: p.chain.map(x=>`<b>${x.stage}:</b> <span class="mono">${x.value}</span>`)
  });
}

function renderISO(frac,pct,preset=null){
  clearResults();
  const pctN=Number(pct);
  const fracLabel = (frac==="ePM25") ? "ePM2,5" : frac;

  setSummary(`Eingabe: <b class="mono">${fracLabel} ${pctN}%</b><br><span class="mono">${ISO_FRAC_DESC[frac]||""}</span>`);
  if(preset) renderChain(preset);

  const cand = isoToEn779(frac,pctN);
  const candText = cand.length ? cand.map(id=>EN779.find(x=>x.id===id)?.label||id).join(" · ") : "—";

  addCard({
    title:"EN 779 (Bestandsanlagen)",
    badge:"Vergleich",
    main:candText,
    ampelLevel:"green",
    useTitle:"Wofür nutzt man EN 779 hier?",
    useText:"Zum Abgleich alter Unterlagen / Bestandsangaben.",
    useHint:"EN 779 ist alt. Für Neubestellung: ISO 16890 Werte aus dem Datenblatt.",
    items:[
      (frac==="ePM1" && pctN>=55 && pctN<=65) ? "<b>Merke:</b> ePM1 60% liegt häufig im Bereich von F7." : "Hinweis: keine 1:1 Umrechnung."
    ]
  });

  // MERV grob
  let mervHint="MERV 11–14 (Richtwert)";
  if(frac==="Coarse") mervHint="MERV 6–8 (Richtwert)";
  if(frac==="ePM10" && pctN<50) mervHint="MERV 8 (Richtwert)";
  if(frac==="ePM10" && pctN>=50 && pctN<70) mervHint="MERV 9–10 (Richtwert)";
  if(frac==="ePM1" && pctN>=50 && pctN<70) mervHint="MERV 13 (Richtwert)";
  if(frac==="ePM1" && pctN>=70 && pctN<85) mervHint="MERV 14 (Richtwert)";
  if(frac==="ePM1" && pctN>=85 && pctN<95) mervHint="MERV 15 (Richtwert)";
  if(frac==="ePM1" && pctN>=95) mervHint="MERV 16 (Richtwert)";

  addCard({
    title:"MERV (US-System)",
    badge:"Vergleich",
    main:mervHint,
    ampelLevel:"yellow",
    useTitle:"Wofür nutzt man MERV hier?",
    useText:"Wenn US-Unterlagen/Herstellerangaben vorliegen.",
    useHint:"Vergleich ist grob. Für EU lieber ISO 16890 Werte nutzen.",
    items:["Andere Prüfmethode als ISO 16890 → deshalb nur Richtwert."]
  });

  addCard({
    title:"HEPA / EPA / ULPA (EN 1822)",
    badge:"HEPA",
    main:"E10–E12 / H13–H14 / U15–U17",
    ampelLevel:"red",
    useTitle:"Wofür ist EN 1822?",
    useText:"Für HEPA/ULPA-Endfilter (eigene Norm mit Leckageprüfung).",
    useHint:"Nicht umrechnen. Entscheidend: korrekter Einbau, Dichtheit, kein Bypass.",
    items:["Wenn HEPA: Vorfilter + Feinfilter davor sind wichtig (Standzeit)."]
  });

  setPrintMeta(`ISO 16890: ${fracLabel} ${pctN}%`);
}

function renderEN779(cls,preset=null){
  clearResults();
  const obj=EN779.find(x=>x.id===cls);
  setSummary(`Eingabe: <b class="mono">${obj?obj.label:cls}</b><br><span class="mono">Einsatz: ${obj?.stage||"—"}</span>`);
  if(preset) renderChain(preset);

  const h=EN779_TO_HINT[cls];

  addCard({
    title:"ISO 16890 (aktuelle Norm)",
    badge:"Vergleich",
    main:(h?.iso||["—"]).join(" · "),
    ampelLevel:"green",
    useTitle:"Wofür nutzt man ISO 16890?",
    useText:"Für aktuelle Filterangaben im Datenblatt (ePM-Werte).",
    useHint:"Herstellerwerte sind maßgeblich (Druckverlust/Standzeit/Dichtheit).",
    items:["ISO 16890 ist heute üblich für Ausschreibung/Bestellung."]
  });

  addCard({
    title:"MERV (US-System)",
    badge:"Vergleich",
    main:(h?.merv||["—"]).join(" · "),
    ampelLevel:"yellow",
    useTitle:"Wofür nutzt man MERV?",
    useText:"Nur wenn US-Angaben vorliegen.",
    useHint:"Nicht 1:1. Für EU-Bestellung bevorzugt ISO 16890.",
    items:["Als Richtwert für internationale Unterlagen."]
  });

  addCard({
    title:"Kurze Praxis-Erklärung",
    badge:obj?.stage||"",
    main:obj?obj.id:cls,
    ampelLevel:"green",
    useTitle:"Wofür nutzt man das in der Anlage?",
    useText: obj?.stage==="Vorfilter" ? "Vorfilter zum Schutz der Anlage und zur Standzeitverlängerung." :
            obj?.stage?.includes("Feinfilter") || obj?.stage==="Feinfilter" ? "Feinfilter für Zuluftqualität / Feinstaubabscheidung." :
            "Filterstufe zur Einordnung.",
    useHint:"Achte beim Wechsel: Dichtungen, Sitz, Bypass vermeiden. Pfeilrichtung beachten.",
    items: obj?.notes || []
  });

  setPrintMeta(`EN 779: ${obj?obj.label:cls}`);
}

function renderEN1822(id,preset=null){
  clearResults();
  const obj=EN1822.find(x=>x.id===id) || EN1822.find(x=>x.id.startsWith(id));
  setSummary(`Eingabe: <b class="mono">${obj?.id||id}</b><br><span class="mono">${obj?.eff||"—"} • ${obj?.use||""}</span>`);
  if(preset) renderChain(preset);

  addCard({
    title:"HEPA/EPA/ULPA Klasse (EN 1822)",
    badge:"HEPA",
    main:obj?.id||id,
    ampelLevel:"red",
    useTitle:"Wofür nutzt man das?",
    useText:"Als Endfilter in sensiblen Bereichen – eigene Norm mit Leckageprüfung.",
    useHint:"Für Monteure: korrekter Einbau + Dichtheit = entscheidend (sonst bringt die Klasse nichts).",
    items:[`Mindestwirkungsgrad: <span class="mono">${obj?.eff||"—"}</span>`]
  });

  addCard({
    title:"Hinweis",
    badge:"Info",
    main:"Keine Umrechnung aus ISO/EN 779",
    ampelLevel:"red",
    useTitle:"Warum keine Umrechnung?",
    useText:"HEPA ist ein eigener Filtertyp mit anderer Prüfung (MPPS/Leckage).",
    useHint:"Typisch: Vorfilter + Feinfilter (hoch) vor HEPA-Endfilter.",
    items:[]
  });

  setPrintMeta(`EN 1822: ${obj?.id||id}`);
}

function renderMERV(id,preset=null){
  clearResults();
  const obj=MERV.find(x=>x.id===id);
  setSummary(`Eingabe: <b class="mono">${id}</b><br><span class="mono">US-System – Vergleich zu ISO/EN nur Richtwert.</span>`);
  if(preset) renderChain(preset);

  addCard({
    title:"MERV (ASHRAE 52.2)",
    badge:"US-System",
    main:id,
    ampelLevel:"yellow",
    useTitle:"Wofür nutzt man das?",
    useText:"Für US-Unterlagen / internationale Angaben.",
    useHint:"Wenn du in Deutschland bestellst: besser ISO 16890 (Datenblatt) nutzen.",
    items:[obj?`ISO-Richtwert: <span class="mono">${obj.iso}</span>`:"ISO-Richtwert: —", obj?obj.use:"Einsatz: —"]
  });

  let enHint="—";
  const n=Number((id.match(/[0-9]{1,2}/)||[])[0]||0);
  if(n<=8) enHint="G4-Bereich";
  if(n>=9 && n<=12) enHint="M5/M6-Bereich";
  if(n===13) enHint="F7-Bereich";
  if(n===14) enHint="F8-Bereich";
  if(n>=15) enHint="F9-Bereich";

  addCard({
    title:"EN 779 (Bestand)",
    badge:"Vergleich",
    main:enHint + " (Richtwert)",
    ampelLevel:"green",
    useTitle:"Wofür nutzt man das?",
    useText:"Zum Abgleich mit Bestandsunterlagen/Filterrahmenbeschriftung.",
    useHint:"EN 779 ist alt, aber in Bestandsanlagen üblich dokumentiert.",
    items:["Altbezeichnungen: F5≈M5, F6≈M6."]
  });

  setPrintMeta(`MERV: ${id}`);
}

/* ========= Montagehilfe: Taschenfilter ========= */

function mountCheck(){
  const W = Number($("mW").value);
  const H = Number($("mH").value);
  const orient = $("mOrient").value;   // vertical/horizontal
  const need = $("mNeed").value;       // hang/stand

  if(!W || !H || W<50 || H<50){
    $("mOut").innerHTML = "Bitte Breite und Höhe (mm) eingeben (z. B. 592 × 592).";
    return;
  }

  // Heuristik (praxisnah):
  // - Vertikal: Taschen sollen nach unten hängen → „Höhe“ ist die Richtung der Schwerkraft.
  // - Horizontal: Taschen dürfen nicht aufliegen → besser so drehen, dass Taschen „seitlich“ frei hängen können.
  // Annahme: Taschen benötigen eher die größere Rahmenrichtung als „Hänge-Richtung“.
  const bigger = (H>=W) ? "H" : "W";
  const smaller = (H>=W) ? "W" : "H";

  let status = "ok"; // ok/warn/bad
  let msg = "";
  let tips = [];

  tips.push("Immer den Luftstrom-Pfeil und ggf. „TOP/OBEN“ am Filter beachten.");
  tips.push("Taschen dürfen nicht auf der Fläche aufliegen oder umknicken → müssen frei hängen/stehen.");

  if(orient==="vertical"){
    // Vertikal ist meistens unkritischer, weil Taschen nach unten hängen können.
    status = "ok";
    msg = `<b>Vertikal-Einbau:</b> In der Regel korrekt, wenn die Taschen <b>nach unten hängen</b> und nicht seitlich anstoßen.`;
    tips.push("Achte auf ausreichenden Freiraum nach unten (kein Boden/Querträger direkt unter den Taschen).");
    tips.push(`Wenn der Rahmen rechteckig ist: meist so einbauen, dass die <b>größere Abmessung</b> (${bigger==="H" ? "Höhe" : "Breite"}) die „Hänge-Richtung“ unterstützt (Taschen brauchen Platz).`);
  } else {
    // Horizontal kann kritisch sein: Taschen liegen ggf. auf.
    status = "warn";
    msg = `<b>Horizontal-Einbau:</b> Kritischer. Taschen können <b>aufliegen</b> und <b>umknicken</b> → Druckverlust steigt, Filter „zu“.`;
    tips.push("Wenn möglich: Filter so montieren, dass Taschen nicht nach unten auf eine Fläche drücken (Taschen müssen frei hängen).");
    tips.push("Oft ist vertikaler Einbau für Taschenfilter günstiger.");
    tips.push(`Bei rechteckigem Rahmen: prüfe, ob Drehen des Rahmens hilft (damit Taschen mehr „Höhe“/Freiraum haben).`);

    // Wenn „need=hang“ und horizontal → erhöhte Gefahr
    if(need==="hang"){
      status = "bad";
      tips.push("Wenn die Taschen sichtbar aufliegen: Einbaulage ändern (vertikal) oder Rahmen drehen/anderer Filtertyp.");
    }
  }

  // Zusatz-Heuristik anhand Seitenverhältnis:
  const ratio = Math.max(W,H) / Math.min(W,H);
  if(ratio >= 1.35){
    // deutlich rechteckig → Orientierung wichtiger
    tips.push("Rechteckiger Rahmen: Taschenrichtung besonders prüfen – falsche Lage führt häufiger zu Umknicken.");
    if(orient==="horizontal") status = (status==="bad") ? "bad" : "warn";
  }

  let badge = "";
  if(status==="ok") badge = `<span class="lamp g"></span> <b>OK</b> – geringe Knickgefahr`;
  if(status==="warn") badge = `<span class="lamp y"></span> <b>Achtung</b> – Taschenlage prüfen`;
  if(status==="bad") badge = `<span class="lamp r"></span> <b>Hohes Risiko</b> – Taschen knicken/liegen auf`;

  $("mOut").innerHTML = `
    <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;">
      <div class="ampel">${badge}</div>
      <div style="color:var(--muted); font-size:12px;">
        Maß: <span class="mono">${W} × ${H} mm</span> • Einbaulage: <b>${orient==="vertical" ? "Vertikal" : "Horizontal"}</b>
      </div>
    </div>
    <div style="margin-top:8px; color:var(--text);">${msg}</div>
    <div style="margin-top:10px; color:var(--muted); font-size:12px; line-height:1.45;">
      <b>Praxis-Checkliste:</b>
      <ul style="margin:6px 0 0; padding-left:18px;">
        ${tips.map(t=>`<li>${t}</li>`).join("")}
      </ul>
    </div>
  `;
}

/* ========= Wiring ========= */
function refreshMode(){
  const v=$("stdSelect").value;
  show("isoBlock", v==="iso16890");
  show("en779Block", v==="en779");
  show("en1822Block", v==="en1822");
  show("mervBlock", v==="merv");
}
function fillSelects(){
  $("en779Sel").innerHTML = EN779.map(x=>`<option value="${x.id}">${x.label}</option>`).join("");
  $("en1822Sel").innerHTML = EN1822.map(x=>`<option value="${x.id}">${x.id}</option>`).join("");
  $("mervSel").innerHTML = MERV.map(x=>`<option value="${x.id}">${x.id}</option>`).join("");
  $("presetSel").innerHTML = PRESETS.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
}
function updatePresetHint(){
  const p=PRESETS.find(x=>x.id===$("presetSel").value);
  $("presetHint").textContent = p ? ("Kurzinfo: " + p.notes.join(" ")) : "";
}
function applyFromUI(){
  const std=$("stdSelect").value;
  if(std==="iso16890") renderISO($("isoFrac").value, $("isoPct").value);
  if(std==="en779") renderEN779($("en779Sel").value);
  if(std==="en1822") renderEN1822($("en1822Sel").value);
  if(std==="merv") renderMERV($("mervSel").value);
}
function applyQuick(){
  const p=parseQuick($("quickInput").value);
  if(!p) return false;
  $("stdSelect").value=p.std; refreshMode();
  if(p.std==="iso16890"){ $("isoFrac").value=p.iso.frac; $("isoPct").value=p.iso.pct; renderISO(p.iso.frac,p.iso.pct); }
  if(p.std==="en779"){ $("en779Sel").value=p.en779.cls; renderEN779(p.en779.cls); }
  if(p.std==="en1822"){ $("en1822Sel").value=p.en1822.id; renderEN1822(p.en1822.id); }
  if(p.std==="merv"){ $("mervSel").value=p.merv.id; renderMERV(p.merv.id); }
  return true;
}
function applyPreset(){
  const p=PRESETS.find(x=>x.id===$("presetSel").value);
  if(!p) return;
  $("stdSelect").value=p.apply.std; refreshMode();
  if(p.apply.std==="iso16890"){ $("isoFrac").value=p.apply.iso.frac; $("isoPct").value=p.apply.iso.pct; renderISO(p.apply.iso.frac,p.apply.iso.pct,p); }
  if(p.apply.std==="en779"){ $("en779Sel").value=p.apply.en779.cls; renderEN779(p.apply.en779.cls,p); }
  if(p.apply.std==="en1822"){ $("en1822Sel").value=p.apply.en1822.id; renderEN1822(p.apply.en1822.id,p); }
  if(p.apply.std==="merv"){ $("mervSel").value=p.apply.merv.id; renderMERV(p.apply.merv.id,p); }
}
function resetAll(){
  $("stdSelect").value="iso16890";
  $("quickInput").value="";
  $("isoFrac").value="ePM1";
  $("isoPct").value=60;
  $("en779Sel").value="F7";
  $("en1822Sel").value="H13 (HEPA)";
  $("mervSel").value="MERV 13";
  $("presetSel").value="office_std";
  updatePresetHint();
  refreshMode();
  renderISO("ePM1",60);
  $("mW").value=""; $("mH").value="";
  $("mOrient").value="vertical";
  $("mNeed").value="hang";
  $("mOut").innerHTML = "Trage Maße ein und prüfe. Hinweis: <b>Luftstrom-Pfeil</b> und <b>Aufdruck „TOP“</b> am Filter immer beachten.";
}

$("stdSelect").addEventListener("change", refreshMode);
$("applyBtn").addEventListener("click", ()=>{ if(!applyQuick()) applyFromUI(); });
$("resetBtn").addEventListener("click", resetAll);
$("presetSel").addEventListener("change", updatePresetHint);
$("presetApplyBtn").addEventListener("click", applyPreset);
$("printBtn").addEventListener("click", ()=>window.print());
$("quickInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); if(!applyQuick()) applyFromUI(); }});

$("mCheckBtn").addEventListener("click", mountCheck);
$("mResetBtn").addEventListener("click", ()=>{
  $("mW").value=""; $("mH").value="";
  $("mOrient").value="vertical";
  $("mNeed").value="hang";
  $("mOut").innerHTML = "Trage Maße ein und prüfe. Hinweis: <b>Luftstrom-Pfeil</b> und <b>Aufdruck „TOP“</b> am Filter immer beachten.";
});

fillSelects();
updatePresetHint();
refreshMode();
renderISO("ePM1",60);
</script>
</body>
</html>
